function upama_highlight(id,node) {
    var pos = id.split("x");
    var spaces = 0;
    var startnode, endnode;
    var startpos = -1;
    var endpos = -1;
    if(pos[0] == 0) {
        var startpos = 0;
        var startnode = node.childNodes[0];
    }

    function recurseElements(node) {
        var kids=node.childNodes;
        for(var i=0;i<kids.length;i++) {
            var kid = kids[i];
            if(kids[i].nodeType == 3) { // text node
                var kidtext = kid.data;
                var space = kidtext.indexOf(" ");
                while(space >= 0) {
                    spaces++;
                    if(spaces == pos[0] && startpos == -1) {
                        startpos = space+1;
                        startnode = kid;
                    }
                    else if(spaces == pos[1]) {
                        endpos = space;
                        endnode = kid;
                        return 1;
                    }
                    space = kidtext.indexOf(" ",space+1);
                }
            } 
            else {
                if(!kid.classList.contains('ignored'))
                    if(recurseElements(kid)) return 1;
            }
        }
        return 0;
    }
    
    recurseElements(node);

    var newNode = document.createElement('span');
    newNode.className = "highlight";
    var doc = node.ownerDocument;
    var middleRange = doc.createRange();
    middleRange.setStart(startnode,startpos);
    middleRange.setEnd(endnode,endpos);
    var middlebit = middleRange.extractContents();
    newNode.appendChild(middlebit);
    middleRange.insertNode(newNode);
}

window.addEventListener ("load", upama_initialize);

function upama_initialize() {
    var apparati = document.getElementsByClassName("apparatus");
    var mains = document.getElementsByClassName("maintext");
    var sigla = document.getElementsByClassName("sidebar-siglum");
    var pagelinks = {};
    for(var z=0;z<sigla.length;z++) {
        var pageid = sigla[z].getAttribute("data-pageid");
        var siglum = sigla[z].innerHTML;
        pagelinks[siglum] = pageid;
    }
    for(var i=0;i<mains.length;i++) {
        mains[i].myOldContent = mains[i].innerHTML;
    }
    for(var n=0;n<apparati.length;n++) {
        var variants = apparati[n].getElementsByClassName("variant");
        for(var i=0;i<variants.length;i++) {
            
            variants[i].myMainText = n;
            variants[i].onmouseover = function() {
                var hipos = this.parentNode.getAttribute('data-loc');
                upama_highlight(hipos,mains[this.myMainText]);
                };
            variants[i].onmouseout = function() {
                mains[this.myMainText].innerHTML = mains[this.myMainText].myOldContent;
                }; 

            var readings = variants[i].parentNode.getElementsByClassName("reading");
            var readlength = readings.length;
            var msarray = new Array();
            
            /*var msids = variants[i].parentNode.getElementsByClassName("msid");
            for(var p=0;p<msids.length;p++) {
                var siglum = msids[p].innerHTML;
                msarray[siglum] = msids[p];
                msids[p].setAttribute("href","?id="+pagelinks[siglum]);
            }*/
            
            if(readlength > 0) {
               var msids = variants[i].parentNode.getElementsByClassName("msid");
                for(var p=0;p<msids.length;p++) {
                    msarray[msids[p].innerHTML] = msids[p];
                }
                variants[i].myOldText = variants[i].innerHTML;

                for(var q=0;q<readlength;q++) {
                    var ms = readings[q].getAttribute("data-ms");
                    var msNode = msarray[ms];
                    msNode.myNewText = readings[q].innerHTML;
                    msNode.classList.add("mshover");
                    msNode.onmouseover = function() {
                        var varNode = this.parentNode.getElementsByClassName("variant")[0];
                        varNode.innerHTML = this.myNewText;
                        varNode.classList.add("varreading");
                        };
                    msNode.onmouseout = function() {
                        var varNode = this.parentNode.getElementsByClassName("variant")[0];
                        varNode.innerHTML = varNode.myOldText;
                        varNode.classList.remove("varreading");
                        };
                } 
            } // end if(readlength > 0)
        }
    }
}
